<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Gesture Particles with Live View</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: 'Segoe UI', sans-serif; }
        
        /* UI Overlay */
        #ui {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); pointer-events: none;
        }
        .highlight { color: #00f2ff; font-weight: bold; text-transform: uppercase; }

        /* Camera Preview Window */
        #preview-container {
            position: absolute; bottom: 20px; right: 20px;
            width: 240px; height: 180px;
            border-radius: 12px; overflow: hidden;
            border: 2px solid #00f2ff; box-shadow: 0 0 20px rgba(0,242,255,0.3);
            background: #111; z-index: 10;
        }
        #input_video { display: none; }
        #output_canvas { width: 100%; height: 100%; transform: scaleX(-1); } /* Mirror the view */

        canvas#three-canvas { display: block; }
    </style>
</head>
<body>

    <div id="ui">
        <h2 style="margin:0;">Nebula Controller</h2>
        <p>Shape: <span id="shape-name" class="highlight">Heart</span></p>
        <p>Status: <span id="status-text">Starting Camera...</span></p>
        <hr style="opacity: 0.2;">
        <small>Pinch fingers to <b>Attract</b><br>Move hand to <b>Switch Shapes</b></small>
    </div>

    <div id="preview-container">
        <canvas id="output_canvas"></canvas>
    </div>
    
    <video id="input_video"></video>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.158.0/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');

        // --- 1. THREE.JS SCENE SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 50;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.domElement.id = "three-canvas";
        document.body.appendChild(renderer.domElement);

        const PARTICLE_COUNT = 15000;
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(PARTICLE_COUNT * 3);
        for(let i=0; i < PARTICLE_COUNT * 3; i++) positions[i] = (Math.random() - 0.5) * 100;
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

        const material = new THREE.PointsMaterial({
            color: 0x00f2ff, size: 0.12, transparent: true, blending: THREE.AdditiveBlending, opacity: 0.7
        });
        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        // --- 2. GESTURE & SHAPE LOGIC ---
        let currentShape = 'HEART';
        let handPos = { x: 0, y: 0, z: 0 };
        let isPinching = false;

        const shapeGenerators = {
            HEART: (i) => {
                const t = Math.random() * Math.PI * 2;
                return new THREE.Vector3(
                    16 * Math.pow(Math.sin(t), 3) * 0.7,
                    (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * 0.7,
                    (Math.random() - 0.5) * 5
                );
            },
            SATURN: (i) => {
                if (i % 5 === 0) {
                    return new THREE.Vector3().setFromSphericalCoords(9, Math.random() * Math.PI, Math.random() * Math.PI * 2);
                } else {
                    const angle = Math.random() * Math.PI * 2;
                    const r = 14 + Math.random() * 8;
                    return new THREE.Vector3(Math.cos(angle) * r, (Math.random() - 0.5) * 2, Math.sin(angle
